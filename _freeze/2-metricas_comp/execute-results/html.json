{
  "hash": "286b3cfff92dc86d61a764feefe39fcf",
  "result": {
    "markdown": "# Métricas compuestas\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# if (!require(\"pacman\")) install.packages(\"pacman\")\npacman::p_load(tidyverse, epifitter, emmeans, performance, ggResidpanel, multcomp, multcompView)\ntheme_set(theme_light()) \n```\n:::\n\n\n## AUC\n\nArea bajo la curva de progreso de la enfermedad\n\nReproducción de: [APS-AUDPC](https://www.apsnet.org/edcenter/disimpactmngmnt/topc/EcologyAndEpidemiologyInR/DiseaseProgress/Pages/AUDPC.aspx)\n\n\n::: {.cell}\n\n```{.r .cell-code}\nepi <- tibble(\n  time = c(1,2,3,4), \n  dis = c(1,2,3,10))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nepi %>%  \n  ggplot()+\n  aes(x=time, y = dis)+\n  geom_point()+\n  geom_line()\n```\n:::\n\n\nArea bajo la curva del progreso de la enfermedad (ABC) - Absoluta\n\n\n::: {.cell}\n\n```{.r .cell-code}\nabc_1  <- with(epi, \n                 AUDPC(time = time, \n                  y = dis, \n                  y_proportion = FALSE, \n                  type = \"absolute\"))  \nabc_1\n```\n:::\n\n\nABC standarizada\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsabc1 <- abc_1/(4-1)\nsabc1\n```\n:::\n\n\nAplicación a un caso real\n\nReproducción de: [APS Stripe rust](https://www.apsnet.org/edcenter/disimpactmngmnt/topc/EcologyAndEpidemiologyInR/DiseaseProgress/Pages/StripeRust.aspx)\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## Set up vector for Madras AUDPC Chart\ndat <- tibble(\n  dai = c(0,10,20,30,40,50,60,70,80,90,100), \n  sev_68 = c(0,0,0,0,3,20,50,80, 90, 100, 100), \n  sev_69 = c( 0,0,0,0,0,0,0,3,6,30,70)\n)\ndat\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndat %>%  \n  ggplot()+\n  aes(x = dai) +\n  geom_line(aes(y = sev_68), col=\"red\")+\n  geom_line(aes(y = sev_69), col=\"blue\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Epidemia de 1968\nwith(dat, \n     AUDPC(time = dai, \n      y = sev_68, \n      y_proportion = FALSE, \n      type = \"absolute\"))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Epidemia de 1969\nwith(dat, \n     AUDPC(time = dai, \n      y = sev_69, \n      y_proportion = FALSE, \n      type = \"absolute\"))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# un poco de coding\ndat %>%  \n  pivot_longer(\n    cols= c(sev_68, sev_69), \n    names_to = \"epidemia\", \n    values_to = \"sev\", \n    names_prefix = \"sev_\")-> dat_long\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndat_long %>%\n  ggplot()+\n  aes(x = dai, y = sev, col=epidemia) +\n  geom_line()\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndat_long %>%  \n  group_by(epidemia) %>%  \n  summarise(abc=AUDPC(time = dai, \n                        y = sev, \n                        y_proportion = FALSE, \n                        type = \"absolute\"))\n```\n:::\n\n\n## DSI\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# poroto  <-  rio::import(\"data/poroto.csv\")\nporoto <- read.csv(\"https://raw.githubusercontent.com/epifito/fitopatometria-r/main/data/poroto.csv\")\n```\n:::\n\n\nDisease severity index (Indice de severidad)\n\n-   Poroto/sclerotinia\n\nDataset de formato wide, que incluye 3 variables descriptivas y 4 variables respuesta.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nporoto %>% \n  mutate(diseased = class_1 + class_2 + class_3 + class_4)  %>% \n  mutate(inc_p = diseased/n) %>% \n  # mutate(dsi_eq1 = (1*class_1+2*class_2+3*class_3+4*class_4)/(n*4) *100) %>% \n  # mutate(dsi_eq2 = (1*class_1+2*class_2+3*class_3+4*class_4)/n) %>% \n  mutate(dsi = (.13*class_1 +.375*class_2 + .625*class_3 + .875*class_4)/n*100) %>%   \n  mutate(dsi_p = dsi/100) %>% \n  mutate_at(vars(trt, rep), as.factor) -> poroto_dsi\nporoto_dsi\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nporoto_dsi %>%  \n  ggplot() + \n  aes(x=trt, y =dsi) + \n  geom_point(alpha=.3)\n```\n:::\n\n\nModel fitting\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmod1 <- lm(dsi ~ trt, data = poroto_dsi)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nresid_panel(mod1, plots = c(\"resid\", \"qq\"))\ncheck_heteroscedasticity(mod1)\ncheck_normality(mod1)\ncld(emmeans(mod1, ~ trt, type = \"response\"))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmod2 <- lm(sqrt(dsi) ~ trt, data = poroto_dsi)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nresid_panel(mod2, plots = c(\"resid\", \"qq\"))\ncheck_heteroscedasticity(mod2)\ncheck_normality(mod2)\ncld(emmeans(mod2, ~ trt, type = \"response\"))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nasin_tran <- make.tran(\"asin.sqrt\", 100)\nmod3 <- with(asin_tran,\n            lm(linkfun(dsi) ~ trt, data = poroto_dsi)\n            )\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nresid_panel(mod3, plots = c(\"resid\", \"qq\"))\ncheck_heteroscedasticity(mod3)\ncheck_normality(mod3)\ncld(emmeans(mod3, ~ trt, type = \"response\"))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmod4 = lm(log(dsi_p/(1-dsi_p)) ~ trt, data = poroto_dsi)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nresid_panel(mod4, plots = c(\"resid\", \"qq\"))\ncheck_heteroscedasticity(mod4)\ncheck_normality(mod4)\ncld(emmeans(mod4, ~trt, \n        tran = \"logit\", \n        type = \"response\"))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ncompare_performance(mod1, mod2, mod3, mod4)\n```\n:::\n\n\n## Enfermedades que inducen senescencia\n\nEnsayo de fungicidas en cebada (trt=3). DBCA con 4 rep. Evaluaciones de sev media a los 0, 9, 20 y 29 dias desde aplicado. Estimacion de AF activa (lo que no es senescencia) La senescencia no cuenta para ninguna enfermedad, ya que es imposible distinguir su causa.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncebada_raw <- read.csv(\"https://raw.githubusercontent.com/epifito/fitopatometria-r/main/data/cebada_redu.csv\")\n```\n:::\n\n\nHacemos un cebada long solo con fines graficos, entonces no creamos `cebada_long`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncebada_long <- cebada_raw %>% \n  pivot_longer(\n    cols = c(\"verdor\", \"e1_sev\", \"e2_sev\"), \n    names_to = \"var\", \n    values_to = \"val\") %>% \n  mutate(var = factor(var),\n         var = fct_relevel(var, \"verdor\")) \n\ncebada_long %>% \n  ggplot()+\n  aes(x=dias, y=val, col = var)+\n  facet_wrap(\"trt\")+\n  geom_point(alpha=0.3) +\n  stat_summary(fun=mean, geom=\"line\", \n               size=0.7, alpha=.5,  \n               aes(col=var, group=var)) +\n  scale_color_manual(\n    labels = c(\"AF\",  \"Sev mancha en red (%)\", \"Sev escaldadura (%)\"),\n    values = c(\"green\", \"red\", \"blue\")\n  ) +\n  theme_bw()+ \n  labs(title = \"Evolución área foliar\",\n       y = \"%\", x = \"Días desde aplicado\", \n       col = \"\")\n```\n:::\n\n\nAhora calculamos el AF sana (%), restando al AF activa, la severidad media de mancha en red y escaldadura.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncebada <- cebada_raw %>% \n  mutate(af_sana = verdor - e1_sev - e2_sev) %>% \n  mutate(sev_tot = e1_sev + e2_sev) \ncebada\n```\n:::\n\n\nFinalmente calculamos el AUC del AF sana (LAI)\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncebada %>% \n  group_by(trt, rep) %>%\n  summarize(auc = AUDPC(time = dias, \n                        y = af_sana, \n                        y_proportion = FALSE, \n                        type = \"absolute\")) -> cebada_auc\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ncebada_auc <- cebada_auc %>% \n  mutate_at(vars(trt, rep), as.factor)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ncebada_auc %>% \n  ggplot()+\n  aes(y=auc, x=trt, col=rep)+\n  geom_point()\n```\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}