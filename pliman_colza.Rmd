---
title: "Untitled"
output: html_document
date: '2022-05-21'
editor_options: 
  chunk_output_type: console
---

```{r}
# https://olivoto.netlify.app/tutorials/pliman_ip/04_phytopathometry/
```

# Setup

```{r setup, include=FALSE}
pacman::p_load(tidyverse, pliman, here)
# pacman::p_load(tidyverse)
conflicted::conflict_prefer("filter", "dplyr")
conflicted::conflict_prefer("select", "dplyr")
```

# Severidad de mildiu en colza

Me situo en la la carpeta que contiene el set de fotos a procesar

```{r}
setwd(here::here("mildiu_pics"))
# getwd()
files <- list.files()%>% data.frame 
```

Indicamos cuales son los pixeles correspondientes a: 
* helathy-sano 
* diseased-enfermo 
* background - fondo 

```{r}
h <- image_import("health.png")
d <- image_import("dis.png")
b <- image_import("back.png")
image_combine(h, d, b, ncol = 3)
```

## Muestra individual

Importación

```{r}
img_ctrol_1.1 <- image_import("ctrol_1-2.png", plot = TRUE)
```

procesamiento 

```{r}
sev_img_ctrol_1.1 <- 
  measure_disease(img = img_ctrol_1.1,
                  img_healthy = h,
                  img_symptoms = d,
                  img_background = b)
sev_img_ctrol_1.1
```

## Batch processing

Ahora pedimos que procese todas las hojas que responden al patron indicado en su nombre de archivo, en este caso que contienen el simbolo "_"

```{r}
sev_lote <- 
    measure_disease(pattern = "_",
                    img_healthy = h,
                    img_symptoms = d,
                    img_background = b,
                    show_image = FALSE,
                    save_image = TRUE,
                    dir_processed = here::here("mildiu_pics", "processed"),
                    show_contour = FALSE)
```


```{r}
sev_lote
```

vemos que es una lista de cuyo elementos nos interesa el dataframe $severity

```{r}
sev_df <- sev_lote[["severity"]]
sev_df
```

`ctrol` = "Testigo",
`inf` = "Fluopicolide + Propamocarb" , 
`ra` = "Ciazofamid"

```{r}
sev_mildiu <- sev_df %>% 
  separate(img, c("trat", "rep", "pl")) %>% 
  group_by(trat, rep) %>% 
  summarise(sev_cond=mean(symptomatic)) %>%  
  ungroup() %>% 
  mutate_at(vars(trat, rep), as.factor)
```

## Incidencia

Datos de incidencia a nivel de parcela

```{r}
inc_mildiu  <- rio::import(here::here("mildiu_pics/inc_mildiu.txt"))%>% mutate_at(vars(trat, rep), as.factor)  
inc_mildiu
str(inc_mildiu)
```

## Joint-data

```{r}
dis_mildiu <- inc_mildiu %>% 
  left_join(sev_mildiu)
dis_mildiu
```

Calculamos severidad media

```{r}
dis_mildiu <- dis_mildiu %>% 
  group_by(trat, rep) %>% 
  mutate(sev_media = sev_cond*(y/n))
```


```{r}
dis_mildiu
save(dis_mildiu, file=here::here("mildiu_pics/mild.Rdata"))
```

```{r}
dis_mildiu %>% 
  ggplot(aes(x=trat, y=y/n*100)) + 
  geom_boxplot() + 
  geom_point() + 
  labs(title = "Incidencia")

dis_mildiu %>% 
  ggplot(aes(x=trat, y=sev_cond)) + 
  geom_boxplot() + 
  geom_point() + 
  labs(title = "Severidad condicional")

dis_mildiu %>% 
  ggplot(aes(x=trat, y=sev_media)) + 
  geom_boxplot() + 
  geom_point() + 
  labs(title = "Severidad media")
```

# OPP 

Reproduciremos el post de Open Plant Pathology escrito por Emerson del Ponte

```{r}
browseURL("https://openplantpathology.org/posts/2021-05-31-measuring-plant-disease-severity-using-the-pliman-r-package/")
```

Noten que pliman requiere R version 4 y el paquete "EBImage" (este paso se hace una sola vez)

```{r}
# install.packages("BiocManager")
# BiocManager::install("EBImage")
```

```{r}
pacman::p_load(tidyverse, pliman, epiR)
```

* Indicar background (b), sano (h) y sintomatico (s) 

```{r}
h <- image_import("pliman/sbr_h.png")
s <- image_import("pliman/sbr_s.png")
b <- image_import("pliman/sbr_b.png")
```

Pedimos que muestre cada imagen indicada anteriormente:

```{r}
image_combine(h, s, b, ncol = 3)
```

* Imagen individual 

Importamos una solo imagen 

```{r}
img46 <- image_import("pliman/originals/img46.png")
image_combine(img46)
```

Pedimos estimar %sintomático / %sano  

```{r}
symptomatic_area(img = img46,
                 img_healthy = h,
                 img_symptoms = s,
                 img_background = b,
                 show_image = TRUE)
```

Y ahora que se haga la magia con todas las imagenes contenidas en una carpeta! 

* Múltiples imagenes 

```{r}
pliman <- symptomatic_area(img_pattern = "img",
                           dir_original = "pliman/originals" ,
                           dir_processed = "pliman/processed",
                           save_image = TRUE,
                           img_healthy = h,
                           img_symptoms = s,
                           img_background = b,
                           show_image = FALSE)
```

WTF! 

```{r}
pliman
```

* Cuán buenas son las estimaciones hechas con pliman??

Estas imagenes evaluadas con pliman fueron evaluadas anteriormente con el software Quant (de conocida precision)

```{r}
quant <- tribble(
  ~sample, ~actual,
  "img5",     75,
  "img11",     24,
  "img35",     52,
  "img37",     38,
  "img38",     17,
  "img46",      7,
  "img63",    2.5,
  "img67",   0.25,
  "img70",     67,
  "img75",     10
)
```

Fusionamos los data frames pliman y quant

```{r}
dat <- left_join(pliman, quant)
dat
```

Visualizamos la confrontacion de las mediciones por ambos métodos, en eje x el "standard gold"y en y el que estamos poniendo a prueba:

```{r}
dat %>% 
  ggplot(aes(actual, symptomatic))+
  geom_point()+
  ylim(0,100)+
  xlim(0,100)+
  geom_abline(slope = 1, intercept = 0)+
  theme_bw()+
  labs(x = "Quant", 
       y = "pliman")
```

Calculamos el coeficiente de correlacion de concordancia entre variables continuas de Lin's (1989, 2000) del paquete "epiR" (llamado en el chunk de session setup)

```{r}
ccc <- epi.ccc(dat$actual, dat$symptomatic)
ccc
ccc$rho.c
```

que tul??
